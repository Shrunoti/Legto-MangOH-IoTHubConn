<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LEGATO: AT client SDD</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="fonts.css" rel="stylesheet" type="text/css" />
<link href="legato.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/javascript">
//<![CDATA[
    // Detect if doc is served by eclipse
    if( ( (window.location.hostname == "127.0.0.1") || (window.location.hostname == "localhost") ) &&
        ( (window.location.port != "") && (window.location.port != 80) && (window.location.port != 443) ) )
    {
        // Inhibit init function from navtree
        initNavTree = function(toroot,relpath) {}
        $(document).ready(function(){
            navTree = document.getElementById("side-nav");
            if(navTree)
            {
                navTree.parentElement.removeChild(navTree);
            }
            $("#doc-content").css('margin-left',10);
        });
    }
//]]>
</script>
<link rel="icon" type="image/png" href="favicon.ico" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html" title="Legato">
      <img alt="Logo" src="legatoLogo.png"/>
    </a>
    <div id="projectbrief">Simplifying IoT development</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('c_SDD_atClient.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AT client SDD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="atClient_service"></a>
AT Client Service</h1>
<h2><a class="anchor" id="Overview"></a>
Overview</h2>
<p>The AT Client Service handles the AT commands sent to the modem on a specified serial device. It also supports getting AT command response. This service can be subscribed by several apps simultaneously.</p>
<h2><a class="anchor" id="atClient_binding"></a>
Device Binding</h2>
<p><a class="el" href="le__at_client__interface_8h.html#a58f48ecb3c1569a4b68be4006a751f36">le_atClient_Start()</a> must be called to bind a specific device with the AT Client. This API starts the device thread, which polls until data is available on the device. A device can be unbound using <a class="el" href="le__at_client__interface_8h.html#a1cf248c81134ae44639ab62e3c501cf1">le_atClient_Stop()</a>.</p>
<p><a class="el" href="le__at_client__interface_8h.html#aead1c543cd8e65d1ad531233af2c7529">le_atClient_Create()</a> creates an AT command reference, then use <a class="el" href="le__at_client__interface_8h.html#a156e43a17cd85dee38fb7ae4182e8864">le_atClient_SetCommand()</a> to set the AT command to be sent to the modem. <a class="el" href="le__at_client__interface_8h.html#a44588125903f97d422ea14c5fd534683">le_atClient_SetDevice()</a> binds the command reference to the device reference.</p>
<p>The following sample code demonstrates how to bind AT Client with device is presented below: </p><div class="fragment"><div class="line"><span class="comment">    //! [binding]</span></div><div class="line"><span class="comment"></span>    <span class="keywordtype">int</span> fd = open(<span class="stringliteral">&quot;/dev/ttyAT&quot;</span>, O_RDWR | O_NOCTTY | O_NONBLOCK);</div><div class="line"></div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(fd &gt;= 0);</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> newFd = dup(fd);</div><div class="line"></div><div class="line">    DevRef = <a class="code" href="le__at_client__interface_8h.html#a58f48ecb3c1569a4b68be4006a751f36">le_atClient_Start</a>(fd);<span class="comment"></span></div><div class="line"><span class="comment">    //! [binding]</span></div><div class="line"><span class="comment"></span></div><div class="line">    <span class="comment">// Try to stop the device</span></div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a1cf248c81134ae44639ab62e3c501cf1">le_atClient_Stop</a>(DevRef) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a1cf248c81134ae44639ab62e3c501cf1">le_atClient_Stop</a>(DevRef) == <a class="code" href="le__basics_8h.html#a1cca095ed6ebab24b57a636382a6c86cac409634423b6b1ef09643529f6224798">LE_FAULT</a>);</div><div class="line"></div><div class="line">    DevRef = <a class="code" href="le__at_client__interface_8h.html#a58f48ecb3c1569a4b68be4006a751f36">le_atClient_Start</a>(newFd);</div><div class="line"></div><div class="line">    newThreadPtr = <a class="code" href="le__thread_8h.html#a87e02a46f92e9e3e11ed28a2b265872f">le_thread_Create</a>(<span class="stringliteral">&quot;TestThread&quot;</span>,TestThread,NULL);</div><div class="line"></div><div class="line">    <a class="code" href="le__thread_8h.html#a38df3877ee5ab9fac17b2fc0be46c27e">le_thread_Start</a>(newThreadPtr);</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> buffer[<a class="code" href="le__at_defs__interface_8h.html#acbaa10c00b1ff1250d2b7338225ea9ea">LE_ATDEFS_RESPONSE_MAX_BYTES</a>];</div><div class="line">    <a class="code" href="le__at_client__interface_8h.html#ab12f48d1655a83a00bd4b2026318a6ad">le_atClient_CmdRef_t</a> cmdRef;</div><div class="line"></div><div class="line">    <span class="comment">// Get S/N</span></div><div class="line">    cmdRef = <a class="code" href="le__at_client__interface_8h.html#aead1c543cd8e65d1ad531233af2c7529">le_atClient_Create</a>();</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a44588125903f97d422ea14c5fd534683">le_atClient_SetDevice</a>(cmdRef, DevRef) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a156e43a17cd85dee38fb7ae4182e8864">le_atClient_SetCommand</a>(cmdRef, <span class="stringliteral">&quot;AT+CGSN&quot;</span>) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a99062518237b59b56faf45f8511419e9">le_atClient_SetFinalResponse</a>(cmdRef, <span class="stringliteral">&quot;OK|ERROR|+CME ERROR&quot;</span>) == LE_OK);</div></div><!-- fragment --><p> The final response of AT command can be set with <a class="el" href="le__at_client__interface_8h.html#a99062518237b59b56faf45f8511419e9">le_atClient_SetFinalResponse()</a>. If an AT command answers with a final response that does not belong to the final responses set, the AT command execution should end by timeout. The timeout can be set with <a class="el" href="le__at_client__interface_8h.html#ae6cabb33a5093aeab2019f12dde27bdb">le_atClient_SetTimeout()</a>, default value is 30s.</p>
<p>The following sample code demonstrates how to set timeout and final response for AT command: </p><div class="fragment"><div class="line">    <span class="comment">// Send a SMS</span></div><div class="line">    <span class="keywordtype">char</span> cmgs[100];</div><div class="line">    memset(cmgs,0,100);</div><div class="line">    <a class="code" href="app_stop_client_8c.html#a2b6c4b2a795957a91039524b524be480">snprintf</a>(cmgs,100,<span class="stringliteral">&quot;AT+CMGS=\&quot;%s\&quot;&quot;</span>, phoneNumber);</div><div class="line"></div><div class="line">    cmdRef = <a class="code" href="le__at_client__interface_8h.html#aead1c543cd8e65d1ad531233af2c7529">le_atClient_Create</a>();</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(cmdRef != NULL);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a156e43a17cd85dee38fb7ae4182e8864">le_atClient_SetCommand</a>(cmdRef, cmgs) == LE_OK);</div><div class="line">    <span class="keywordtype">char</span> sms[]=<span class="stringliteral">&quot;Hello Legato&quot;</span>;</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a45435484c7242dc301cec60417d047b7">le_atClient_SetText</a>(cmdRef, sms) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a44588125903f97d422ea14c5fd534683">le_atClient_SetDevice</a>(cmdRef, DevRef) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#ae6cabb33a5093aeab2019f12dde27bdb">le_atClient_SetTimeout</a>(cmdRef, 0) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#a99062518237b59b56faf45f8511419e9">le_atClient_SetFinalResponse</a>(cmdRef, <span class="stringliteral">&quot;OK|ERROR|+CMS ERROR&quot;</span>) == LE_OK);</div><div class="line">    <a class="code" href="le__log_8h.html#ac0dbbef91dc0fed449d0092ff0557b39">LE_ASSERT</a>(<a class="code" href="le__at_client__interface_8h.html#aaf39cf9ae5ffb4c76a6eefc8be030e7c">le_atClient_Send</a>(cmdRef)==LE_OK);</div></div><!-- fragment --><p> When the AT command declaration is complete, it can be sent using <a class="el" href="le__at_client__interface_8h.html#aaf39cf9ae5ffb4c76a6eefc8be030e7c">le_atClient_Send()</a>. This API is synchronous (blocking until final response is detected, or time out reached).</p>
<h2><a class="anchor" id="atClient_state_machines"></a>
State Machines</h2>
<p>There are two finite state machines, AT command client state machine and Rx parser state machine. The AT command client state machine takes care of writing of AT command onto modem device and Rx parser state machine looks for the response message from the modem device for the AT Command sent by client.</p>
<p>The following diagram describes the client state machine:</p>
<div align="center">
<img src="client_state_machine.png" />
</div>
<p>The following diagram describes the Rx parser state machine:</p>
<div align="center">
<img src="Rx_parser_state_machine.png" />
</div>
<h2><a class="anchor" id="atClient_send"></a>
Sending</h2>
<p><a class="el" href="le__at_client__interface_8h.html#aaf39cf9ae5ffb4c76a6eefc8be030e7c">le_atClient_Send()</a> changes the client state from WaitingState to SendingState. In the SendingState the AT command is written on to the device by le_dev_write(). The reply for the AT command is received by RxNewData(). RxNewData() invokes ParseRxBuffer(), which is responsible for state change in the Rx parser state machine.</p>
<p>ProcessingState sends the final reponse found from the device to the client with event EVENT_PROCESSLINE.</p>
<p>SendingState checks if the response matches with the final string of the command using the CheckResponse(). After checking response, RxNewData() resets Rx buffer which is already read. Client state changes to WaitingState where as Rx parser state waits in ProcessingState.</p>
<h2><a class="anchor" id="atClient__delete"></a>
Deleting</h2>
<p>When the AT command is over, the reference has to be deleted by calling <a class="el" href="le__at_client__interface_8h.html#a8bd3f6ec64a7a700460e4d66b39ec4ed">le_atClient_Delete()</a>.</p>
<p>The following flow diagram describes the AT Client Service:</p>
<div align="center">
<img src="le_atClient.png" />
</div>
<p>Copyright (C) Sierra Wireless Inc. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
   <div class="footer">
        <div>
            <a href="https://www.sierrawireless.com/">
                <img src="swi-ico-medium.png" width="24" alt="" />
                &nbsp;Sierra Wireless
            </a>
            &nbsp;-&nbsp;
            Generated by Doxygen 1.8.11
        </div>
    </div>
</body>
</html>
