<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LEGATO: framework/liblegato/linux/messaging.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="fonts.css" rel="stylesheet" type="text/css" />
<link href="legato.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/javascript">
//<![CDATA[
    // Detect if doc is served by eclipse
    if( ( (window.location.hostname == "127.0.0.1") || (window.location.hostname == "localhost") ) &&
        ( (window.location.port != "") && (window.location.port != 80) && (window.location.port != 443) ) )
    {
        // Inhibit init function from navtree
        initNavTree = function(toroot,relpath) {}
        $(document).ready(function(){
            navTree = document.getElementById("side-nav");
            if(navTree)
            {
                navTree.parentElement.removeChild(navTree);
            }
            $("#doc-content").css('margin-left',10);
        });
    }
//]]>
</script>
<link rel="icon" type="image/png" href="favicon.ico" />
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html" title="Legato">
      <img alt="Logo" src="legatoLogo.png"/>
    </a>
    <div id="projectbrief">Simplifying IoT development</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('messaging_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">messaging.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="legato_8h_source.html">legato.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="service_directory_protocol_8h_source.html">serviceDirectory/serviceDirectoryProtocol.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="messaging_message_8h_source.html">messagingMessage.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="messaging_protocol_8h_source.html">messagingProtocol.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="messaging_session_8h_source.html">messagingSession.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="messaging_interface_8h_source.html">messagingInterface.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a035fe38377fa63708134dc1bafb36f12"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_t_e_m_p_l_a_t_e__cdef_8h.html#ac9c84fa68bbad002983e35ce3663c686">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="messaging_8c.html#a035fe38377fa63708134dc1bafb36f12">msg_Init</a> (<a class="el" href="_t_e_m_p_l_a_t_e__cdef_8h.html#ac9c84fa68bbad002983e35ce3663c686">void</a>)</td></tr>
<tr class="separator:a035fe38377fa63708134dc1bafb36f12"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Legato <a class="el" href="c_messaging.html">Low-level Messaging API</a> implementation.</p>
<p>Following is the basic data model for the part of the low-level messaging subsystem that runs in the interface instances such as the client and the server.</p>
<p>The interface instances share much of the same code and data structures. Protocols, Interfaces, Sessions, and Messages are all the same object types on all interface instances. But, the way they are used and some of of their contents differ among interface instances.</p>
<p>IPC is done using unix domain, sequenced-packet sockets. See the ref c_unixSockets for more information.</p>
<pre class="fragment">*
*   Protocol List --+--&gt; Protocol ---&gt; Message Pool
*                           ^
*                           |
*   Interface ------+--&gt; Interface --+--&gt; socket (server-side only, connected to Service Directory)
*   Instances Map           ^        |
*   (hashmap)               |        +--&gt; Session List
*                           |                 |
*                           | +---------------+
*                           | |
*                           | v
*                        Session ---+--&gt; socket
*                           ^       |
*                           |       +--&gt; Transmit Queue
*                           |                 |
*                        Message &lt;------------+
*                           ^
*                           |
*   Transaction Ref Map ----+
*   (client-side only)
*
* </pre><p>All sockets are put in non-blocking mode and the FD monitoring capabilities of the <a class="el" href="c_eventLoop.html">Event Loop API</a> are used to register for notification when messages arrive on the IPC sockets and when IPC sockets become clear-to-send.</p>
<p>In unix systems, there is a limit to how much socket buffer memory a given socket is allowed to have. Futhermore, with unix domain sockets, all the socket buffer memory is attributed to the sender, even when it is waiting at the receiver socket for someone to receive it. This means that it is possible for a receiver to block another socket from being able to send to anyone (even some other third-party socket) simply by not receiving messages sent from that socket. This can be a very tricky thing to diagnose and can result in deadlocks. To avoid this, a separate socket is used for each session, so that if the other side stops receiving, other sessions are not affected.</p>
<p>In the Legato messaging system implementation, if the send socket's buffer space quota becomes exhausted and attempts to send a message return EAGAIN or EWOULDBLOCK, the Message object is placed on a queue for that socket (in the Session object) and the messaging system waits for notification from the Event Loop that the socket has become clear-to-send before trying again.</p>
<p>Another potential deadlock occurs when two threads are sending messages to each other. If they both send a lot of messages to each other, they can both get blocked waiting for the other side to receive messages that had been sent earlier, and because they are both blocked, neither is able to receive any messages to unblock the other. To avoid this, messages are sent using non-blocking system calls. If the message cannot be sent, it is queued for later transmission when the socket becomes "writeable" again. This makes use of the normal "writeable" file descriptor event monitoring capabilities of the Event Loop API.</p>
<p>Only when a thread calls <a class="el" href="le__messaging_8h.html#aa3cf113b26b154697ccef270dafe8798">le_msg_RequestSyncResponse()</a> will the socket be placed in blocking mode. In that case, the thread will block waiting on a receive operation on the socket. If a message arrives while waiting for a response, the waiting thread will wake up and receive that message. If it is not the message that it was waiting for, then the message is pushed onto the thread's Event Queue for later processing (otherwise, the thread returns from the blocking receive call). Now, if events on other sockets and timers, etc. happen during this time, then those events will be delayed and messages arriving on that one IPC socket will effectively jump ahead of those other events in the Event Queue. The only way to prevent this is to either use asynchronous request-response handling or spawn a separate thread for the blocking request-response. Other solutions were explored, but none were found that didn't create opportunities for unexpected reentrancy and/or unbounded recursion.</p>
<p>Only one thread can wait on a socket. If two threads tried to call <a class="el" href="le__messaging_8h.html#aa3cf113b26b154697ccef270dafe8798">le_msg_RequestSyncResponse()</a> on the same socket, it would be impossible to ensure that the correct response went to each thread. Therefore, only the one thread that owns the session is allowed to call <a class="el" href="le__messaging_8h.html#aa3cf113b26b154697ccef270dafe8798">le_msg_RequestSyncResponse()</a>.</p>
<p>Each message transmission over the socket is prepended by a small header which contains a 4-byte transaction identifier. This is actually a Safe Reference (see <a class="el" href="c_safeRef.html">Safe References API</a>) which is used to match response messages back to their associated request messages on the client side. For all other types of messages, this is set to 0 (NULL) to indicate that it does not belong to a request-response transaction.</p>
<p>See also <a class="el" href="serviceDirectoryProtocol.html">Legato Service Directory Protocol</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>The code in this subsystem <b>must</b> be thread safe and re-entrant.</dd></dl>
<p>Copyright (C) Sierra Wireless Inc. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a035fe38377fa63708134dc1bafb36f12"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_t_e_m_p_l_a_t_e__cdef_8h.html#ac9c84fa68bbad002983e35ce3663c686">void</a> msg_Init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_t_e_m_p_l_a_t_e__cdef_8h.html#ac9c84fa68bbad002983e35ce3663c686">void</a>&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initializes this module. This must be called only once at start-up, before any other functions in this module are called. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
   <div class="footer">
        <div>
            <a href="https://www.sierrawireless.com/">
                <img src="swi-ico-medium.png" width="24" alt="" />
                &nbsp;Sierra Wireless
            </a>
            &nbsp;-&nbsp;
            Generated by Doxygen 1.8.11
        </div>
    </div>
</body>
</html>
